// Tradewave Prisma Schema
// B2B Trade & Logistics Platform with Blockchain Integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  role          UserRole  @default(BUYER)
  status        UserStatus @default(PENDING)
  companyName   String?
  phone         String?
  avatar        String?
  walletAddress String?
  industry      String?
  department    String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified DateTime?
  
  // Relations
  requirements      Requirement[]
  quotations        Quotation[]
  buyerTransactions Transaction[] @relation("BuyerTransactions")
  deliveryConfirmed Transaction[] @relation("DeliveryConfirmedBy")
  qualityAssessed   Transaction[] @relation("QualityAssessedBy")
  fundsReleased     Transaction[] @relation("FundsReleasedBy")
  statusChanges     TransactionStatusHistory[] @relation("StatusChangedBy")
  auditLogs         AuditLog[]
  sessions          Session[]
  accounts          Account[]
  notifications     Notification[]
  activities        Activity[]
  emailPreferences  EmailPreference? @relation("emailPreferences")
  
  // Dispute relations
  filedDisputes     Dispute[]        @relation("DisputeFiler")
  resolvedDisputes  Dispute[]        @relation("DisputeResolver")
  disputeMessages   DisputeMessage[]
  
  // Review relations
  reviewsGiven      Review[]         @relation("ReviewsGiven")
  reviewsReceived   Review[]         @relation("ReviewsReceived")
  reviewsModerator  Review[]         @relation("ReviewModerator")
  reviewAppeals     Review[]         @relation("ReviewAppeals")
  reviewVotes       ReviewVote[]
  ratingStats       UserRatingStats?
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum UserRole {
  BUYER
  ADMIN
  SUPPLIER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

// =============================================================================
// REQUIREMENTS
// =============================================================================

model Requirement {
  id               String            @id @default(cuid())
  buyerId          String
  title            String
  description      String            @db.Text
  category         String
  subcategory      String?
  specifications   Json              @default("{}")
  quantity         Int
  unit             String
  targetPrice      Decimal?          @db.Decimal(15, 2)
  currency         String            @default("USD")
  deliveryLocation String
  deliveryDeadline DateTime
  priority         RequirementPriority @default(MEDIUM)
  status           RequirementStatus @default(DRAFT)
  assignedTo       String?
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  // Relations
  buyer            User              @relation(fields: [buyerId], references: [id])
  quotations       Quotation[]
  transactions     Transaction[]
  attachments      Attachment[]
  
  @@map("requirements")
}

enum RequirementStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  SOURCING
  QUOTATIONS_READY
  NEGOTIATING
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum RequirementPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Attachment {
  id            String      @id @default(cuid())
  requirementId String
  name          String
  url           String
  type          String
  size          Int
  uploadedAt    DateTime    @default(now())
  
  requirement   Requirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  
  @@map("attachments")
}

// =============================================================================
// SUPPLIERS
// =============================================================================

model Supplier {
  id                String        @id @default(cuid())
  name              String
  email             String        @unique
  phone             String?
  companyName       String
  location          String
  categories        String[]
  yearsInBusiness   Int?
  minimumOrderValue Decimal?      @db.Decimal(15, 2)
  leadTime          Int?
  verified          Boolean       @default(false)
  
  overallRating     Decimal?      @db.Decimal(3, 2)
  qualityRating     Decimal?      @db.Decimal(3, 2)
  deliveryRating    Decimal?      @db.Decimal(3, 2)
  communicationRating Decimal?    @db.Decimal(3, 2)
  pricingRating     Decimal?      @db.Decimal(3, 2)
  totalReviews      Int           @default(0)
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  certifications    Certification[]
  quotations        Quotation[]
  transactions      Transaction[]
  
  @@map("suppliers")
}

model Certification {
  id           String    @id @default(cuid())
  supplierId   String
  name         String
  issuingBody  String
  validUntil   DateTime
  documentUrl  String?
  verified     Boolean   @default(false)
  
  supplier     Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  @@map("certifications")
}

// =============================================================================
// QUOTATIONS
// =============================================================================

model Quotation {
  id              String          @id @default(cuid())
  requirementId   String
  supplierId      String
  userId          String?
  
  unitPrice       Decimal         @db.Decimal(15, 2)
  quantity        Int
  subtotal        Decimal         @db.Decimal(15, 2)
  shipping        Decimal?        @db.Decimal(15, 2)
  insurance       Decimal?        @db.Decimal(15, 2)
  customs         Decimal?        @db.Decimal(15, 2)
  taxes           Decimal?        @db.Decimal(15, 2)
  platformFee     Decimal?        @db.Decimal(15, 2)
  total           Decimal         @db.Decimal(15, 2)
  currency        String          @default("USD")
  
  leadTime        Int
  validUntil      DateTime
  terms           String?         @db.Text
  notes           String?         @db.Text
  certifications  String[]
  samples         Boolean         @default(false)
  sampleCost      Decimal?        @db.Decimal(15, 2)
  status          QuotationStatus @default(PENDING)
  ranking         Int?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  requirement     Requirement     @relation(fields: [requirementId], references: [id])
  supplier        Supplier        @relation(fields: [supplierId], references: [id])
  user            User?           @relation(fields: [userId], references: [id])
  transactions    Transaction[]
  
  @@map("quotations")
}

enum QuotationStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  SHORTLISTED
  ACCEPTED
  REJECTED
  EXPIRED
}

// =============================================================================
// TRANSACTIONS
// =============================================================================

model Transaction {
  id                    String            @id @default(cuid())
  requirementId         String
  quotationId           String
  buyerId               String
  supplierId            String
  
  status                TransactionStatus @default(INITIATED)
  amount                Decimal           @db.Decimal(15, 2)
  currency              String            @default("USD")
  paymentMethod         String?
  paymentStatus         PaymentStatus?
  
  smartContractAddress  String?
  
  // Shipping Details
  carrier               String?
  trackingNumber        String?
  trackingUrl           String?
  origin                String?
  destination           String?
  estimatedDelivery     DateTime?
  actualDelivery        DateTime?
  weight                Decimal?          @db.Decimal(10, 2)
  shipmentDate          DateTime?
  shippingProvider      String?
  shipmentNotes         String?           @db.Text
  shipmentPhotos        String[]          // URLs to shipment photos
  
  // Delivery Confirmation
  deliveryConfirmedAt   DateTime?
  deliveryConfirmedById String?
  deliveryLocation      String?
  deliveryNotes         String?           @db.Text
  deliveryPhotos        String[]          // URLs to delivery photos
  
  // Quality Assessment
  qualityAssessmentAt   DateTime?
  qualityAssessedById   String?
  qualityRating         Int?              // 1-5 scale
  qualityNotes          String?           @db.Text
  qualityIssues         String[]          // Array of issues found
  qualityPhotos         String[]          // Evidence photos
  acceptanceReason      String?           @db.Text
  rejectionReason       String?           @db.Text
  
  // Fund Release
  fundsReleasedAt       DateTime?
  fundsReleasedById     String?
  releaseReason         String?           @db.Text
  supplierBankAccount   String?           // Masked
  releaseTransactionId  String?           // Stripe/payment ref
  platformFee           Decimal?          @db.Decimal(15, 2)
  payoutAmount          Decimal?          @db.Decimal(15, 2)
  
  // Blockchain Audit
  blockchainHash        String?
  auditLogId            String?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  // Relations
  requirement           Requirement       @relation(fields: [requirementId], references: [id])
  quotation             Quotation         @relation(fields: [quotationId], references: [id])
  buyer                 User              @relation("BuyerTransactions", fields: [buyerId], references: [id])
  supplier              Supplier          @relation(fields: [supplierId], references: [id])
  deliveryConfirmedBy   User?             @relation("DeliveryConfirmedBy", fields: [deliveryConfirmedById], references: [id])
  qualityAssessedBy     User?             @relation("QualityAssessedBy", fields: [qualityAssessedById], references: [id])
  fundsReleasedBy       User?             @relation("FundsReleasedBy", fields: [fundsReleasedById], references: [id])
  milestones            TransactionMilestone[]
  documents             TransactionDocument[]
  escrow                EscrowTransaction?
  payments              Payment[]
  blockchainDeployments BlockchainDeployment[]
  contractExecutions    SmartContractExecution[]
  documentHashes        DocumentHash[]
  blockchainAuditLogs   BlockchainAuditLog[]
  shipment              Shipment?
  statusHistory         TransactionStatusHistory[]
  dispute               Dispute?
  review                Review?
  
  @@index([status])
  @@index([supplierId, status])
  @@index([buyerId, status])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionStatus {
  INITIATED
  PAYMENT_PENDING
  PAYMENT_RECEIVED
  PAID
  ESCROW_HELD
  PRODUCTION
  SHIPPED
  IN_TRANSIT
  CUSTOMS
  DELIVERED
  DELIVERY_CONFIRMED
  QUALITY_PENDING
  QUALITY_CHECK
  QUALITY_APPROVED
  QUALITY_REJECTED
  FUNDS_RELEASING
  FUNDS_RELEASED
  ESCROW_RELEASED
  COMPLETED
  DISPUTED
  DISPUTE_OPEN
  DISPUTE_RESOLVED
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

model TransactionStatusHistory {
  id            String            @id @default(cuid())
  transactionId String
  transaction   Transaction       @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  oldStatus     TransactionStatus
  newStatus     TransactionStatus
  changedById   String?
  changedBy     User?             @relation("StatusChangedBy", fields: [changedById], references: [id])
  reason        String?           @db.Text
  metadata      Json?
  
  createdAt     DateTime          @default(now())
  
  @@index([transactionId, createdAt])
  @@map("transaction_status_history")
}

model TransactionMilestone {
  id              String            @id @default(cuid())
  transactionId   String
  status          TransactionStatus
  description     String?
  actor           String?
  blockchainTxHash String?
  timestamp       DateTime          @default(now())
  
  transaction     Transaction       @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@map("transaction_milestones")
}

model TransactionDocument {
  id            String              @id @default(cuid())
  transactionId String
  type          DocumentType
  name          String
  url           String
  hash          String?
  verified      Boolean             @default(false)
  uploadedAt    DateTime            @default(now())
  
  transaction   Transaction         @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@map("transaction_documents")
}

enum DocumentType {
  INVOICE
  PACKING_LIST
  CERTIFICATE
  CUSTOMS
  OTHER
}

// =============================================================================
// ESCROW
// =============================================================================

model EscrowTransaction {
  id                String        @id @default(cuid())
  transactionId     String        @unique
  amount            Decimal       @db.Decimal(15, 2)
  currency          String        @default("USD")
  status            EscrowStatus  @default(PENDING)
  holdDate          DateTime?
  releaseDate       DateTime?
  contractAddress   String?
  blockchainTxHash  String?
  
  // Quick access flags for release conditions
  deliveryConfirmed   Boolean     @default(false)
  deliveryConfirmedAt DateTime?
  qualityApproved     Boolean     @default(false)
  qualityApprovedAt   DateTime?
  documentsVerified   Boolean     @default(false)
  documentsVerifiedAt DateTime?
  autoReleaseDate     DateTime?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  transaction       Transaction   @relation(fields: [transactionId], references: [id])
  releaseConditions ReleaseCondition[]
  
  @@map("escrow_transactions")
}

enum EscrowStatus {
  PENDING
  HELD
  RELEASING
  RELEASED
  DISPUTED
  REFUNDED
}

model ReleaseCondition {
  id          String            @id @default(cuid())
  escrowId    String
  type        ReleaseConditionType
  description String
  satisfied   Boolean           @default(false)
  satisfiedAt DateTime?
  satisfiedBy String?
  
  escrow      EscrowTransaction @relation(fields: [escrowId], references: [id], onDelete: Cascade)
  
  @@map("release_conditions")
}

enum ReleaseConditionType {
  DELIVERY_CONFIRMED
  QUALITY_APPROVED
  DOCUMENTS_VERIFIED
  TIME_ELAPSED
}

// =============================================================================
// BLOCKCHAIN
// =============================================================================

model BlockchainDeployment {
  id              String          @id @default(cuid())
  transactionId   String?
  contractType    ContractType
  contractAddress String
  deploymentTxHash String
  blockNumber     Int
  gasUsed         Int?
  gasCost         String?
  network         BlockchainNetwork @default(SEPOLIA)
  status          DeploymentStatus @default(PENDING)
  deployedAt      DateTime        @default(now())
  
  // Relations
  transaction     Transaction?    @relation(fields: [transactionId], references: [id])
  executions      SmartContractExecution[]
  
  @@map("blockchain_deployments")
}

enum ContractType {
  TRADE_AGREEMENT
  DOCUMENT_VERIFICATION
  ESCROW_MANAGEMENT
  AUDIT_LOG
}

enum BlockchainNetwork {
  SEPOLIA
  POLYGON
  MAINNET
}

enum DeploymentStatus {
  PENDING
  DEPLOYING
  DEPLOYED
  FAILED
}

model SmartContractExecution {
  id               String                @id @default(cuid())
  deploymentId     String?
  transactionId    String?
  contractAddress  String
  functionName     String
  parameters       Json                  @default("{}")
  transactionHash  String
  blockNumber      Int?
  status           BlockchainTxStatus    @default(PENDING)
  gasUsed          Int?
  gasCost          String?
  returnValues     Json?
  executedAt       DateTime              @default(now())
  
  // Relations
  deployment       BlockchainDeployment? @relation(fields: [deploymentId], references: [id])
  transaction      Transaction?          @relation(fields: [transactionId], references: [id])
  
  @@map("smart_contract_executions")
}

enum BlockchainTxStatus {
  PENDING
  BROADCASTING
  CONFIRMING
  CONFIRMED
  FAILED
}

model BlockchainAuditLog {
  id              String      @id @default(cuid())
  transactionId   String?
  contractAddress String?
  eventType       String
  action          String
  actor           String
  details         Json        @default("{}")
  blockNumber     Int?
  txHash          String?
  timestamp       DateTime    @default(now())
  immutable       Boolean     @default(true)
  
  // Relations
  transaction     Transaction? @relation(fields: [transactionId], references: [id])
  
  @@map("blockchain_audit_logs")
}

model DocumentHash {
  id                  String    @id @default(cuid())
  transactionId       String
  documentType        String
  originalName        String
  hash                String
  algorithm           String    @default("SHA256")
  contractAddress     String?
  blockchainTxHash    String?
  verified            Boolean   @default(false)
  uploadedAt          DateTime  @default(now())
  verifiedAt          DateTime?
  
  // Relations
  transaction         Transaction @relation(fields: [transactionId], references: [id])
  
  @@map("document_hashes")
}

model BlockchainTransaction {
  id              String              @id @default(cuid())
  transactionHash String              @unique
  contractAddress String?
  functionCalled  String?
  parameters      Json?
  status          BlockchainTxStatus  @default(PENDING)
  confirmations   Int                 @default(0)
  blockNumber     Int?
  gasUsed         Int?
  gasCost         String?
  network         BlockchainNetwork   @default(SEPOLIA)
  createdAt       DateTime            @default(now())
  confirmedAt     DateTime?
  
  @@map("blockchain_transactions")
}

// =============================================================================
// LEADS (Non-registered users who create requirements)
// =============================================================================

model Lead {
  id              String      @id @default(cuid())
  email           String      @unique
  fullName        String
  companyName     String
  phoneNumber     String
  
  category        String      // "Metals", "Chemicals", etc.
  productName     String
  quantity        Int
  unit            String
  location        String
  timeline        String
  additionalReqs  String?     @db.Text
  
  status          LeadStatus  @default(NEW_LEAD)
  notes           String?     @db.Text
  assignedTo      String?
  lastContactedAt DateTime?
  convertedAt     DateTime?
  convertedUserId String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("leads")
}

enum LeadStatus {
  NEW_LEAD
  CONTACTED
  QUALIFIED
  CONVERTED
  REJECTED
  UNRESPONSIVE
}

// =============================================================================
// PAYMENTS
// =============================================================================

model Payment {
  id                String        @id @default(cuid())
  transactionId     String
  amount            Decimal       @db.Decimal(15, 2)
  currency          String        @default("USD")
  method            PaymentMethod @default(STRIPE)
  status            PaymentStatus @default(PENDING)
  
  // Stripe/Provider details
  providerPaymentId String?       // stripe payment intent id
  clientSecret      String?       // for frontend confirmation
  providerFee       Decimal?      @db.Decimal(15, 2)
  
  // Bank transfer details
  bankReference     String?
  bankAccount       String?
  
  paidAt            DateTime?
  failedAt          DateTime?
  refundedAt        DateTime?
  refundAmount      Decimal?      @db.Decimal(15, 2)
  
  metadata          Json?         @default("{}")
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  transaction       Transaction   @relation(fields: [transactionId], references: [id])
  
  @@map("payments")
}

enum PaymentMethod {
  STRIPE
  WIRE_TRANSFER
  BANK_TRANSFER
  CRYPTO
  ESCROW
}

// =============================================================================
// NOTIFICATIONS
// =============================================================================

model Notification {
  id          String            @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  resourceType String?          // "requirement", "transaction", "quotation"
  resourceId  String?
  read        Boolean           @default(false)
  readAt      DateTime?
  
  createdAt   DateTime          @default(now())
  
  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@map("notifications")
}

enum NotificationType {
  REQUIREMENT_CREATED
  QUOTATION_RECEIVED
  QUOTATION_ACCEPTED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  ESCROW_HELD
  ESCROW_RELEASED
  SHIPMENT_UPDATE
  DELIVERY_CONFIRMED
  QUALITY_APPROVED
  DOCUMENTS_VERIFIED
  TRANSACTION_COMPLETED
  DISPUTE_OPENED
  REVIEW_SUBMITTED
  REVIEW_APPROVED
  REVIEW_REJECTED
  SYSTEM
}

// =============================================================================
// ACTIVITY LOG (Detailed user activity tracking)
// =============================================================================

model Activity {
  id          String       @id @default(cuid())
  userId      String?
  type        ActivityType
  action      String
  description String?
  resourceType String?     // "requirement", "transaction", "quotation", etc.
  resourceId  String?
  metadata    Json?        @default("{}")
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime     @default(now())
  
  // Relations
  user        User?        @relation(fields: [userId], references: [id])
  
  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
  @@map("activities")
}

enum ActivityType {
  REQUIREMENT
  QUOTATION
  TRANSACTION
  PAYMENT
  ESCROW
  SHIPMENT
  DOCUMENT
  USER
  SYSTEM
}

// =============================================================================
// AUDIT LOG (Application Level)
// =============================================================================

model AuditLog {
  id          String    @id @default(cuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  
  user        User?     @relation(fields: [userId], references: [id])
  
  @@map("audit_logs")
}

// =============================================================================
// SHIPMENT TRACKING
// =============================================================================

model Shipment {
  id                  String         @id @default(cuid())
  transactionId       String         @unique
  trackingNumber      String         @unique
  carrier             String         // DHL, FedEx, UPS, Local Courier
  status              ShipmentStatus @default(PENDING)
  originLocation      String
  currentLocation     String
  destinationLocation String
  estimatedDelivery   DateTime
  actualDelivery      DateTime?
  updates             Json?          // Array of tracking updates
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  // Relations
  transaction         Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@index([transactionId])
  @@index([trackingNumber])
  @@index([status])
  @@map("shipments")
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  DELAYED
  LOST
  CANCELLED
}

// =============================================================================
// ADMIN SETTINGS
// =============================================================================

model AdminSetting {
  id          String    @id @default(cuid())
  key         String    @unique
  value       String    // Can be JSON string
  description String?
  category    String?   // FEES, SECURITY, COMPLIANCE
  updatedBy   String
  updatedAt   DateTime  @updatedAt
  
  @@index([key])
  @@map("admin_settings")
}

// =============================================================================
// SECURITY LOG
// =============================================================================

model SecurityLog {
  id          String          @id @default(cuid())
  userId      String?
  eventType   SecurityEventType
  details     Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime        @default(now())
  
  @@index([userId])
  @@index([timestamp])
  @@map("security_logs")
}

enum SecurityEventType {
  LOGIN
  LOGOUT
  FAILED_LOGIN
  PERMISSION_DENIED
  SETTINGS_CHANGED
  DATA_EXPORTED
  PASSWORD_CHANGED
  ACCOUNT_LOCKED
}

// =============================================================================
// EMAIL SYSTEM
// =============================================================================

model EmailLog {
  id            String      @id @default(cuid())
  recipient     String
  subject       String
  templateName  String
  status        EmailStatus @default(PENDING)
  sentAt        DateTime?
  failureReason String?     @db.Text
  retryCount    Int         @default(0)
  maxRetries    Int         @default(3)
  resendId      String?     @unique
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([recipient, status])
  @@index([createdAt])
  @@index([status])
  @@map("email_logs")
}

model EmailPreference {
  id                       String    @id @default(cuid())
  userId                   String    @unique
  user                     User      @relation("emailPreferences", fields: [userId], references: [id], onDelete: Cascade)

  quoteNotifications       Boolean   @default(true)
  transactionNotifications Boolean   @default(true)
  paymentNotifications     Boolean   @default(true)
  deliveryNotifications    Boolean   @default(true)
  disputeNotifications     Boolean   @default(true)
  systemNotifications      Boolean   @default(true)
  weeklyDigest             Boolean   @default(false)

  unsubscribedAt           DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  @@map("email_preferences")
}

model EmailBounce {
  id         String      @id @default(cuid())
  email      String      @unique
  bounceType BounceType
  reason     String?
  bouncedAt  DateTime
  createdAt  DateTime    @default(now())

  @@index([email])
  @@map("email_bounces")
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum BounceType {
  PERMANENT
  TEMPORARY
}

// =============================================================================
// DISPUTE RESOLUTION SYSTEM
// =============================================================================

model Dispute {
  id                String      @id @default(cuid())
  transactionId     String      @unique
  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Who filed
  filedByUserId     String
  filedByUser       User        @relation("DisputeFiler", fields: [filedByUserId], references: [id])
  
  // Details
  reason            String      // QUALITY_ISSUE, NOT_RECEIVED, DIFFERENT_ITEM, PAYMENT_NOT_RECEIVED, OTHER
  description       String      @db.Text
  status            DisputeStatus @default(PENDING)
  
  // Evidence
  evidenceUrls      String[]    @default([])
  
  // Resolution
  requestedResolution String    // FULL_REFUND, PARTIAL_REFUND, ITEM_EXCHANGE, FULL_PAYMENT, SPLIT_50_50
  adminDecision     String?     // The decision made: FULL_REFUND, PARTIAL_REFUND, FULL_PAYMENT, SPLIT_50_50
  resolutionAmount  Float?      // Amount to refund or split
  resolutionReason  String?     @db.Text
  
  // Fund distribution
  buyerAmount       Float?
  supplierAmount    Float?
  
  // Admin
  reviewedByAdminId String?
  reviewedByAdmin   User?       @relation("DisputeResolver", fields: [reviewedByAdminId], references: [id])
  
  // Timeline
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  resolvedAt        DateTime?
  closedAt          DateTime?
  
  // Messages
  messages          DisputeMessage[]
  
  // Blockchain
  blockchainHash    String?
  blockchainTxId    String?
  
  @@index([status])
  @@index([filedByUserId])
  @@index([createdAt])
  @@map("disputes")
}

enum DisputeStatus {
  PENDING
  UNDER_REVIEW
  AWAITING_RESPONSE
  RESOLVED
  CLOSED
  ESCALATED
}

model DisputeMessage {
  id                String      @id @default(cuid())
  disputeId         String
  dispute           Dispute     @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  userId            String
  user              User        @relation(fields: [userId], references: [id])
  message           String      @db.Text
  attachments       String[]    @default([])
  isAdmin           Boolean     @default(false)
  createdAt         DateTime    @default(now())
  
  @@index([disputeId, createdAt])
  @@map("dispute_messages")
}

// =============================================================================
// REVIEW SYSTEM
// =============================================================================

model Review {
  id                    String      @id @default(cuid())
  transactionId         String      @unique
  transaction           Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // Who is reviewing whom
  reviewerUserId        String
  reviewerUser          User        @relation("ReviewsGiven", fields: [reviewerUserId], references: [id])
  reviewedUserId        String
  reviewedUser          User        @relation("ReviewsReceived", fields: [reviewedUserId], references: [id])
  
  // Review type
  reviewType            String      // BUYER_REVIEW_SELLER or SELLER_REVIEW_BUYER
  
  // Ratings (1-5 stars)
  overallRating         Int         // 1-5
  communicationRating   Int         // 1-5 (how responsive/clear)
  reliabilityRating     Int         // 1-5 (on-time delivery, quality, payment)
  
  // For sellers: product quality, delivery speed
  // For buyers: payment reliability, professionalism
  categoryRating        Int?        // 1-5 (context-specific)
  
  // Review content
  title                 String?
  description           String      @db.Text
  tags                  String[]    @default([])  // GREAT_COMMUNICATION, FAST_DELIVERY, HIGH_QUALITY, PROFESSIONAL, etc
  
  // Evidence
  attachmentUrls        String[]    @default([])
  
  // Moderation
  status                String      @default("PENDING")  // PENDING, APPROVED, REJECTED, APPEAL
  moderationReason      String?
  reviewedByAdminId     String?
  reviewedByAdmin       User?       @relation("ReviewModerator", fields: [reviewedByAdminId], references: [id])
  
  // Dispute/Appeal
  appealReason          String?     @db.Text
  appealedAt            DateTime?
  appealedByUserId      String?
  appealedByUser        User?       @relation("ReviewAppeals", fields: [appealedByUserId], references: [id])
  
  // Engagement
  helpfulCount          Int         @default(0)
  notHelpfulCount       Int         @default(0)
  votes                 ReviewVote[]
  
  // Timeline
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  approvedAt            DateTime?
  
  @@index([reviewedUserId])
  @@index([reviewerUserId])
  @@index([status])
  @@index([createdAt])
  @@map("reviews")
}

model ReviewVote {
  id                    String      @id @default(cuid())
  reviewId              String
  review                Review      @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId                String
  user                  User        @relation(fields: [userId], references: [id])
  
  voteType              String      // HELPFUL or NOT_HELPFUL
  createdAt             DateTime    @default(now())
  
  @@unique([reviewId, userId])
  @@map("review_votes")
}

model UserRatingStats {
  id                    String      @id @default(cuid())
  userId                String      @unique
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Overall stats
  averageRating         Float       @default(0)
  totalReviews          Int         @default(0)
  approvedReviews       Int         @default(0)
  
  // Breakdown
  fiveStarCount         Int         @default(0)
  fourStarCount         Int         @default(0)
  threeStarCount        Int         @default(0)
  twoStarCount          Int         @default(0)
  oneStarCount          Int         @default(0)
  
  // Category averages
  avgCommunicationRating Float      @default(0)
  avgReliabilityRating  Float       @default(0)
  avgCategoryRating     Float       @default(0)
  
  // Trust indicators
  trustScore            Float       @default(0)  // 0-100
  trustBadge            String?     // GOLD (4.8+), SILVER (4.5+), BRONZE (4.0+)
  
  // For buyers
  paymentReliability    Float       @default(0)  // 0-100
  disputeCount          Int         @default(0)
  
  // Timeline
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@map("user_rating_stats")
}
